# JSON è§£æå¢å¼ºè¯´æ˜

## âœ… å·²åº”ç”¨çš„ä¿®å¤

### é—®é¢˜èƒŒæ™¯

åœ¨ä½¿ç”¨ DeepSeek-V3.2 æ¨¡å‹ç”Ÿæˆå†…å®¹æ—¶ï¼Œé‡åˆ°ä¸¤ç±» JSON è§£æé”™è¯¯ï¼š

1. **Markdown ä»£ç å—åŒ…è£¹**ï¼šLLM è¿”å›çš„ JSON è¢«åŒ…è£¹åœ¨ ` ```json ` å’Œ ` ``` ` ä¸­
2. **å“åº”æˆªæ–­**ï¼šLLM ç”Ÿæˆä¸å®Œæ•´çš„ JSONï¼ˆå¯èƒ½å›  token é™åˆ¶æˆ–æ¨¡å‹åœæ­¢ï¼‰

### ä¿®å¤æ–¹æ¡ˆ

å·²åœ¨ [path-based-generator.ts](src/lib/path-based-generator.ts:418-531) å®ç°äº†**5å±‚å®¹é”™æœºåˆ¶**ï¼š

```
å°è¯• 1: åŸºç¡€æ¸…ç†ï¼ˆç§»é™¤ markdown + å°¾éšé€—å·ï¼‰
    â†“ å¤±è´¥
å°è¯• 2: æ‰©å±•æ¸…ç†ï¼ˆ7ç§æ¸…ç†æ“ä½œï¼‰
    â†“ å¤±è´¥
å°è¯• 3: æ™ºèƒ½æˆªæ–­ï¼ˆfindLastValidJSON æ‰¾åˆ°æœ€åæœ‰æ•ˆä½ç½®ï¼‰
    â†“ å¤±è´¥
è¿”å›å‹å¥½çš„é”™è¯¯æç¤º + è¯Šæ–­å»ºè®®
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. é‡å¯å¼€å‘æœåŠ¡å™¨

```bash
# æŒ‰ Ctrl+C åœæ­¢å½“å‰æœåŠ¡å™¨
# ç„¶åé‡æ–°å¯åŠ¨
npm run dev
```

**é‡è¦**ï¼šVite ä¼šç¼“å­˜ç¯å¢ƒå˜é‡ï¼Œå¿…é¡»é‡å¯æ‰èƒ½åŠ è½½æ–°ä»£ç ã€‚

### 2. åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•

æ‰“å¼€æµè§ˆå™¨åï¼Œåœ¨æ§åˆ¶å°è¾“å…¥ï¼š

```javascript
// 1. æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
console.log(llm.config)
// åº”è¯¥æ˜¾ç¤ºï¼š
// {
//   provider: 'customOpenAI',
//   apiKey: 'sk-tbzveiitbdbulucampwzweqztebhjgprnfzixoefmaucinzx',
//   baseURL: 'https://api.siliconflow.cn/v1',
//   model: 'deepseek-ai/DeepSeek-V3.2'
// }

// 2. å‡†å¤‡ä½ çš„çŸ¥è¯†è·¯å¾„ï¼ˆä½¿ç”¨ä½ ä¹‹å‰çš„ 14 ä¸ª NLP çŸ¥è¯†ç‚¹ï¼‰
const knowledgePath = [
  {
    "knowledge_id": "D02-M01-K008",
    "name": "è‡ªç„¶è¯­è¨€å¤„ç†æ¦‚è¿°",
    "description": "è‡ªç„¶è¯­è¨€å¤„ç†æ˜¯äººå·¥æ™ºèƒ½ååˆ†é‡è¦çš„ç ”ç©¶é¢†åŸŸ...",
    // ... (å®Œæ•´è·¯å¾„)
  }
  // ... å…¶ä»– 13 ä¸ªçŸ¥è¯†ç‚¹
]

// 3. ç”Ÿæˆå†…å®¹
const data = await llm.generateFromPath({
  knowledge_path: knowledgePath,
  style: 'comprehensive'
})

// 4. æ£€æŸ¥ç»“æœ
console.log('ç”ŸæˆæˆåŠŸï¼', data)
console.log('é¡µé¢æ ‡é¢˜:', data.title)
console.log('Block æ•°é‡:', data.blocks.length)

// 5. ä¸‹è½½ç”Ÿæˆçš„æ–‡ä»¶
llm.download(data, 'nlp-intro.json')
```

---

## ğŸ” è§£æè¡Œä¸ºè¯´æ˜

### æˆåŠŸåœºæ™¯ 1ï¼šå®Œæ•´ JSON

å¦‚æœ LLM è¿”å›å®Œæ•´æœ‰æ•ˆçš„ JSONï¼š

```
âœ… å°è¯• 1 æˆåŠŸ
è¿”å›å®Œæ•´æ•°æ®
```

### æˆåŠŸåœºæ™¯ 2ï¼šMarkdown åŒ…è£¹

å¦‚æœ LLM è¿”å›ï¼š
```
```json
{
  "page_id": "xxx",
  ...
}
```
```

```
âš ï¸  å°è¯• 1 å¤±è´¥ï¼ˆæ— æ³•è§£æï¼‰
â†’ è‡ªåŠ¨ç§»é™¤ markdown æ ‡è®°
âœ… å°è¯• 2 æˆåŠŸ
è¿”å›æ¸…ç†åçš„æ•°æ®
```

### æˆåŠŸåœºæ™¯ 3ï¼šæˆªæ–­çš„ JSON

å¦‚æœ LLM è¿”å›ä¸å®Œæ•´çš„ JSONï¼š
```json
{
  "page_id": "nlp-intro",
  "title": "...",
  "blocks": [
    {
      "type": "hero",
      "content": {
```
ï¼ˆåœ¨ä¸­é—´æˆªæ–­ï¼‰

```
âš ï¸  å°è¯• 1 å¤±è´¥
âš ï¸  å°è¯• 2 å¤±è´¥
â†’ findLastValidJSON() æ‰¾åˆ°æœ€åä¸€ä¸ª }
âœ… å°è¯• 3 æˆåŠŸï¼ˆæˆªæ–­ä¿®å¤ï¼‰
console.log: "âœ… é€šè¿‡æˆªæ–­æ–¹å¼æˆåŠŸè§£æéƒ¨åˆ†å†…å®¹"
è¿”å›éƒ¨åˆ†æ•°æ®ï¼ˆå¯èƒ½ç¼ºå°‘åé¢çš„ blocksï¼‰
```

### å¤±è´¥åœºæ™¯ï¼šæ— æ³•ä¿®å¤

å¦‚æœ JSON æŸåè¿‡äºä¸¥é‡ï¼š

```
âš ï¸  å°è¯• 1 å¤±è´¥
âš ï¸  å°è¯• 2 å¤±è´¥
âš ï¸  å°è¯• 3 å¤±è´¥
âŒ æŠ›å‡ºé”™è¯¯ + è¯Šæ–­å»ºè®®
```

---

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹åŸå§‹å“åº”

å¦‚æœè§£æå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ä¼šåŒ…å«å“åº”é¢„è§ˆï¼š

```
Response preview: ```json
{
  "page_id": "nlp-intro-overview",
  "title": "è‡ªç„¶è¯­è¨€å¤„ç†ï¼šä»å…¥é—¨åˆ°ç†è§£",
  "summary": "ç³»ç»Ÿæ€§åœ°å­¦ä¹ è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰...",
  "blocks": [
    {
      "type": "hero",
      "title":...
```

è¿™å¯ä»¥å¸®åŠ©ä½ ï¼š
1. **è¯†åˆ«æˆªæ–­ä½ç½®**ï¼šæŸ¥çœ‹ JSON åœ¨å“ªé‡Œè¢«æˆªæ–­
2. **åˆ¤æ–­é—®é¢˜ç±»å‹**ï¼šæ˜¯ markdown åŒ…è£¹ã€å°¾éšé€—å·ï¼Œè¿˜æ˜¯çœŸæ­£çš„æˆªæ–­
3. **ä¼˜åŒ– Prompt**ï¼šæ ¹æ®æˆªæ–­ä½ç½®è°ƒæ•´æç¤º

### æ£€æŸ¥ Token ä½¿ç”¨

ç”Ÿæˆæ—¶ä¼šæ˜¾ç¤ºï¼š

```
ğŸ“ åŸºäºçŸ¥è¯†è·¯å¾„ç”Ÿæˆå†…å®¹...
   çŸ¥è¯†ç‚¹æ•°é‡: 14
âœ… ç”Ÿæˆå®Œæˆ (4502ms)
   ä½¿ç”¨ tokens: 1832
```

- **è¾“å…¥ tokens**ï¼šä½ çš„ knowledge_path é•¿åº¦
- **è¾“å‡º tokens**ï¼šLLM ç”Ÿæˆçš„ JSON é•¿åº¦
- å¦‚æœæ¥è¿‘æ¨¡å‹çš„ token é™åˆ¶ï¼Œè€ƒè™‘å‡å°‘çŸ¥è¯†ç‚¹æ•°é‡

---

## ğŸ¯ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### å¦‚æœæŒç»­å‡ºç°æˆªæ–­é—®é¢˜

#### é€‰é¡¹ 1ï¼šå‡å°‘çŸ¥è¯†ç‚¹æ•°é‡

```javascript
// ä» 14 ä¸ªå‡å°‘åˆ° 7-8 ä¸ª
const shortPath = knowledgePath.slice(0, 7)

const data = await llm.generateFromPath({
  knowledge_path: shortPath,
  style: 'comprehensive'
})
```

#### é€‰é¡¹ 2ï¼šä½¿ç”¨ç²¾ç®€é£æ ¼

```javascript
const data = await llm.generateFromPath({
  knowledge_path: knowledgePath,
  style: 'concise' // ç”Ÿæˆæ›´ç®€æ´çš„å†…å®¹
})
```

#### é€‰é¡¹ 3ï¼šåˆ†æ‰¹ç”Ÿæˆ

```javascript
// ç”Ÿæˆç¬¬ä¸€æ‰¹ï¼ˆå‰ 7 ä¸ªçŸ¥è¯†ç‚¹ï¼‰
const batch1 = await llm.generateFromPath({
  knowledge_path: knowledgePath.slice(0, 7)
})

// ç”Ÿæˆç¬¬äºŒæ‰¹ï¼ˆå 7 ä¸ªçŸ¥è¯†ç‚¹ï¼‰
const batch2 = await llm.generateFromPath({
  knowledge_path: knowledgePath.slice(7, 14)
})

// æ‰‹åŠ¨åˆå¹¶ï¼ˆå¯é€‰ï¼‰
const merged = {
  ...batch1,
  blocks: [...batch1.blocks, ...batch2.blocks]
}
```

#### é€‰é¡¹ 4ï¼šè°ƒæ•´å‰ªæç­–ç•¥

åœ¨ [path-based-generator.ts:220](src/lib/path-based-generator.ts:220) è°ƒæ•´ï¼š

```typescript
// å½“å‰ï¼šåªå¯¹é‡ç‚¹/éš¾ç‚¹/å…³æ³¨ç‚¹æ·»åŠ è¯¦ç»†ä¿¡æ¯
const isImportant = kp.is_key_point || kp.is_difficult || isFocus;

// æ›´ä¸¥æ ¼ï¼šåªå¯¹ key_point æ·»åŠ è¯¦ç»†ä¿¡æ¯
const isImportant = kp.is_key_point;

// æ›´å®½æ¾ï¼šä¸å‰ªæï¼ˆæ‰€æœ‰ç‚¹éƒ½è¯¦ç»†ä¿¡æ¯ï¼‰
const isImportant = true; // æ‰€æœ‰çŸ¥è¯†ç‚¹éƒ½è¯¦ç»†
```

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

```
âŒ Error: Unexpected token '`', "```json\n{\n\"... is not valid JSON
```

### ä¿®å¤å

**åœºæ™¯ 1**ï¼šMarkdown åŒ…è£¹
```
âœ… è§£ææˆåŠŸï¼ˆè‡ªåŠ¨ç§»é™¤ markdownï¼‰
```

**åœºæ™¯ 2**ï¼šJSON æˆªæ–­
```
âš ï¸  é¦–æ¬¡ JSON è§£æå¤±è´¥ï¼Œå°è¯•æ›´å¤šæ¸…ç†...
âš ï¸  ç¬¬äºŒæ¬¡è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤ JSON æ ¼å¼...
âœ… é€šè¿‡æˆªæ–­æ–¹å¼æˆåŠŸè§£æéƒ¨åˆ†å†…å®¹
```

**åœºæ™¯ 3**ï¼šå®Œå…¨æŸå
```
âŒ Error: Failed to parse LLM response
ğŸ’¡ æç¤ºï¼šLLM å¯èƒ½ç”Ÿæˆäº†ä¸å®Œæ•´æˆ–æœ‰è¯­æ³•é”™è¯¯çš„ JSONã€‚
   å¯ä»¥å°è¯•ï¼š
   1. ä½¿ç”¨æ›´å¥½çš„æ¨¡å‹ï¼ˆå¦‚ GPT-4ï¼‰
   2. ç®€åŒ–çŸ¥è¯†è·¯å¾„ï¼ˆå‡å°‘çŸ¥è¯†ç‚¹æ•°é‡ï¼‰
   3. æ£€æŸ¥ Prompt æ˜¯å¦è¿‡äºå¤æ‚
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ¸…ç†æ“ä½œï¼ˆå°è¯• 2ï¼‰

```typescript
jsonStr = jsonStr
  // 1. ç§»é™¤å¯èƒ½å‰©ä½™çš„ markdown æ ‡è®°
  .replace(/```\w*\n?/g, '')
  .replace(/```\w*$/g, '')
  // 2. ç§»é™¤æ³¨é‡Š
  .replace(/\/\*[\s\S]*?\*\//g, '')
  // 3. ç§»é™¤è¡Œå°¾é€—å·
  .replace(/,(\s*\n)/g, '$1')
  // 4. ä¿®å¤æœªé—­åˆçš„å¼•å·
  .replace(/"([^"]*?)$/gm, '"$1"')
  // 5. ç§»é™¤æ§åˆ¶å­—ç¬¦
  .replace(/[\x00-\x1f\x7f-\x9f]/g, '')
  // 6. ç§»é™¤ BOM
  .replace(/^\uFEFF/, '');
```

### æ™ºèƒ½æˆªæ–­ï¼ˆå°è¯• 3ï¼‰

```typescript
private findLastValidJSON(str: string): number {
  let bracketCount = 0;
  let maxPos = 0;

  for (let i = 0; i < str.length; i++) {
    const char = str[i];

    if (char === '{') {
      bracketCount++;
    } else if (char === '}') {
      bracketCount--;
      if (bracketCount === 0) {
        maxPos = i + 1; // æ‰¾åˆ°å®Œæ•´çš„å¯¹è±¡
      }
    }
  }

  return maxPos; // è¿”å›æœ€åä¸€ä¸ªå®Œæ•´å¯¹è±¡çš„ä½ç½®
}
```

**å·¥ä½œåŸç†**ï¼š
- é€å­—ç¬¦æ‰«æ JSON å­—ç¬¦ä¸²
- è·Ÿè¸ª `{` å’Œ `}` çš„å¹³è¡¡
- è®°å½•æœ€åä¸€ä¸ªå®Œæ•´å¯¹è±¡çš„ä½ç½®
- æˆªæ–­åˆ°è¯¥ä½ç½®å¹¶æ·»åŠ  `}` é—­åˆ

**ç¤ºä¾‹**ï¼š

```json
{
  "page_id": "test",
  "blocks": [
    {"type": "hero"
```
â†“ æ‰«æç»“æœ
```json
{
  "page_id": "test"
}
```
ï¼ˆæˆªæ–­åˆ° `page_id` åçš„ `}`ï¼Œä¸¢å¼ƒæœªé—­åˆçš„ `blocks`ï¼‰

---

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•æ—¶è¯·ç¡®è®¤ï¼š

- [ ] å¼€å‘æœåŠ¡å™¨å·²é‡å¯
- [ ] é…ç½®æ˜¾ç¤º `customOpenAI`
- [ ] æ¨¡å‹æ˜¾ç¤º `deepseek-ai/DeepSeek-V3.2`
- [ ] ç”Ÿæˆè¿‡ç¨‹æ˜¾ç¤º token ä½¿ç”¨æƒ…å†µ
- [ ] JSON è§£ææˆåŠŸæˆ–ç»™å‡ºæœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯
- [ ] ç”Ÿæˆçš„ `data` åŒ…å« `page_id`, `title`, `blocks`
- [ ] å¯ä»¥ä½¿ç”¨ `llm.download()` ä¸‹è½½ç»“æœ

---

## ğŸ†˜ ä»ç„¶å¤±è´¥ï¼Ÿ

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ä»ç„¶å¤±è´¥ï¼Œè¯·æä¾›ï¼š

1. **å®Œæ•´çš„æ§åˆ¶å°è¾“å‡º**ï¼ˆä» `ğŸ“ åŸºäºçŸ¥è¯†è·¯å¾„ç”Ÿæˆå†…å®¹...` å¼€å§‹ï¼‰
2. **é”™è¯¯ä¿¡æ¯**ï¼ˆåŒ…æ‹¬ Response previewï¼‰
3. **çŸ¥è¯†è·¯å¾„é•¿åº¦**ï¼ˆå¤šå°‘ä¸ªçŸ¥è¯†ç‚¹ï¼‰
4. **Token ä½¿ç”¨æƒ…å†µ**ï¼ˆè¾“å…¥/è¾“å‡º tokensï¼‰

è¿™æ ·å¯ä»¥å¸®åŠ©è¿›ä¸€æ­¥è¯Šæ–­é—®é¢˜ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PATH_BASED_GENERATION.md](./PATH_BASED_GENERATION.md) - åŸºäºçŸ¥è¯†è·¯å¾„çš„ç”ŸæˆæŒ‡å—
- [PATH_GENERATOR_OPTIMIZATION.md](./PATH_GENERATOR_OPTIMIZATION.md) - å·²åº”ç”¨çš„ä¼˜åŒ–è¯´æ˜
- [LLM_INTEGRATION.md](./LLM_INTEGRATION.md) - LLM é›†æˆæ€»è§ˆ
