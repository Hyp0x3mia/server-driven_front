# ğŸš€ æœ€ç»ˆ Token é™åˆ¶ä¿®å¤

## ğŸ“Š æœ€æ–°çŠ¶æ€

ä»æœ€æ–°çš„æ—¥å¿—åˆ†æï¼š

```
âœ… LLM è¯·æ±‚æˆåŠŸ (149719ms)
åŸå§‹å“åº”é•¿åº¦: 7508 å­—ç¬¦
âœ… ç§»é™¤ markdown ä»£ç å—æ ‡è®°
æ¸…ç†åé•¿åº¦: 7496 å­—ç¬¦
findLastValidJSON æ‰¾åˆ°ä½ç½®: 7309
æ·»åŠ é—­åˆæ‹¬å·:  â† ç©ºçš„ï¼è¯´æ˜æ‹¬å·æ˜¯å¹³è¡¡çš„
âŒ è§£æå¤±è´¥
```

**å…³é”®å‘ç°**ï¼š
- å“åº”é•¿åº¦ 7508 å­—ç¬¦ï¼Œä½† JSON ä»ç„¶è¢«æˆªæ–­
- `findLastValidJSON` è®¤ä¸ºæ‰¾åˆ°äº†å®Œæ•´å¯¹è±¡ï¼ˆæ‹¬å·å¹³è¡¡ï¼‰
- ä½† JSON.parse ä»ç„¶åœ¨ position 32 å¤±è´¥
- è¿™è¯´æ˜ **JSON å†…éƒ¨æœ‰è¯­æ³•é”™è¯¯**ï¼Œä¸æ˜¯ç®€å•çš„æˆªæ–­é—®é¢˜

## âœ… å·²åº”ç”¨çš„æœ€æ–°ä¿®å¤

### 1. å¤§å¹…å¢åŠ  maxTokens

**æ–‡ä»¶**: [src/lib/llm-client.ts:107](src/lib/llm-client.ts:107)

```typescript
export const DEFAULT_CONFIG: Partial<LLMConfig> = {
  temperature: 0.7,
  maxTokens: 16384, // ä» 8192 å¢åŠ åˆ° 16384
  timeout: 120000,  // ä» 60s å¢åŠ åˆ° 120s (2åˆ†é’Ÿ)
  headers: {
    'Content-Type': 'application/json'
  }
};
```

### 2. æ·»åŠ æˆªæ–­ç‚¹è°ƒè¯•

**æ–‡ä»¶**: [src/lib/path-based-generator.ts:499-504](src/lib/path-based-generator.ts:499)

```typescript
// ğŸ” è°ƒè¯•ï¼šæ˜¾ç¤ºæˆªæ–­ç‚¹å‘¨å›´çš„å†…å®¹
const contextStart = Math.max(0, lastValidPos - 150);
const contextEnd = Math.min(jsonStr.length, lastValidPos + 50);
console.log('\nğŸ“ æˆªæ–­ç‚¹å‘¨å›´çš„å†…å®¹ï¼ˆæˆªæ–­ä½ç½®åœ¨ | | ä¹‹é—´ï¼‰:');
console.log(jsonStr.substring(contextStart, lastValidPos) + ' |ğŸ“| ' + jsonStr.substring(lastValidPos, contextEnd));
console.log('');
```

**è¿™å°†æ˜¾ç¤º**ï¼š
- JSON åœ¨å“ªé‡Œæˆªæ–­
- æˆªæ–­ç‚¹å‰åçš„ä¸Šä¸‹æ–‡
- å¸®åŠ©è¯Šæ–­æ˜¯ç®€å•çš„æˆªæ–­è¿˜æ˜¯ JSON æ ¼å¼é”™è¯¯

---

## ğŸ§ª ç«‹å³æµ‹è¯•

**1. é‡å¯æœåŠ¡å™¨**ï¼ˆå¿…é¡»ï¼ï¼‰ï¼š
```bash
npm run dev
```

**2. è¿è¡Œæµ‹è¯•**ï¼š
```javascript
const data = await llm.generateFromPath({
  knowledge_path: knowledgePath,
  style: 'comprehensive'
})
```

**3. æŸ¥çœ‹æ–°çš„è°ƒè¯•è¾“å‡º**ï¼š

ç°åœ¨ä¼šæ˜¾ç¤ºï¼š
```
ğŸ“ æˆªæ–­ç‚¹å‘¨å›´çš„å†…å®¹ï¼ˆæˆªæ–­ä½ç½®åœ¨ | | ä¹‹é—´ï¼‰:
      }
    }
  ],
  "blocks": [
    {
      "type": "hero",
      "title": "è‡ªç„¶è¯­è¨€å¤„ç†åŸºç¡€å…¥é—¨",
      "content": {
        "hero": {
 |ğŸ“|
```

è¿™ä¼šå‘Šè¯‰æˆ‘ä»¬ JSON åœ¨å“ªé‡Œåœæ­¢ã€‚

---

## ğŸ¯ é¢„æœŸç»“æœ

### ç†æƒ³æƒ…å†µ

å¦‚æœ 16384 tokens è¶³å¤Ÿï¼š

```
âœ… LLM è¯·æ±‚æˆåŠŸ (~150000ms)
åŸå§‹å“åº”é•¿åº¦: 15000+ å­—ç¬¦  â† æ¯”ä¹‹å‰å¤šä¸€å€ï¼
âœ… ç§»é™¤ markdown ä»£ç å—æ ‡è®°
âœ… JSON è§£ææˆåŠŸ
âœ… ç”Ÿæˆå®Œæˆ
   Block æ•°é‡: 10+
```

### å¦‚æœä»ç„¶å¤±è´¥

æŸ¥çœ‹è°ƒè¯•è¾“å‡ºä¸­çš„"æˆªæ–­ç‚¹å‘¨å›´å†…å®¹"ï¼Œåˆ¤æ–­ï¼š

**æƒ…å†µ A**ï¼šJSON åœ¨å­—ç¬¦ä¸²ä¸­é—´æˆªæ–­
```
"title": "è‡ªç„¶è¯­è¨€å¤„ç†åŸºç¡€å…¥ |ğŸ“|
```
â†’ **éœ€è¦ç»§ç»­å¢åŠ  maxTokens** æˆ–å‡å°‘çŸ¥è¯†ç‚¹

**æƒ…å†µ B**ï¼šJSON åœ¨å¯¹è±¡ä¸­é—´æˆªæ–­
```
"blocks": [
    {
      "type": "hero" |ğŸ“|
```
â†’ **å¯èƒ½æ˜¯ LLM åœæ­¢ç”Ÿæˆ**ï¼Œæ£€æŸ¥ API æ˜¯å¦æœ‰é™åˆ¶

**æƒ…å†µ C**ï¼šJSON æœ‰è¯­æ³•é”™è¯¯
```
"type": "hero",,,
```
â†’ **LLM ç”Ÿæˆäº†é”™è¯¯çš„ JSON**ï¼Œéœ€è¦æ”¹è¿› Prompt

---

## ğŸ’¡ è¿›ä¸€æ­¥è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå‡å°‘çŸ¥è¯†ç‚¹æ•°é‡ï¼ˆæ¨èï¼‰

14 ä¸ªçŸ¥è¯†ç‚¹ç¡®å®å¾ˆå¤šã€‚å°è¯•åˆ†æ‰¹ï¼š

```javascript
// ç¬¬ä¸€æ‰¹ï¼šå‰ 7 ä¸ª
const batch1 = await llm.generateFromPath({
  knowledge_path: knowledgePath.slice(0, 7),
  style: 'comprehensive'
})

// ç¬¬äºŒæ‰¹ï¼šå 7 ä¸ª
const batch2 = await llm.generateFromPath({
  knowledge_path: knowledgePath.slice(7, 14),
  style: 'comprehensive'
})

// åˆå¹¶
const complete = {
  ...batch1,
  blocks: [...batch1.blocks, ...batch2.blocks]
}

llm.download(complete, 'nlp-complete.json')
```

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ç®€æ´é£æ ¼

```javascript
const data = await llm.generateFromPath({
  knowledge_path: knowledgePath,
  style: 'concise' // â† ç”Ÿæˆæ›´çŸ­çš„å†…å®¹
})
```

### æ–¹æ¡ˆ 3ï¼šæ£€æŸ¥ API é™åˆ¶

æŸäº› API æä¾›å•†å³ä½¿è®¾ç½®äº† `max_tokens: 16384`ï¼Œä¹Ÿå¯èƒ½æœ‰è‡ªå·±çš„ç¡¬é™åˆ¶ã€‚

- ç™»å½• SiliconFlow æ§åˆ¶å°
- æŸ¥çœ‹ DeepSeek-V3.1-Terminus çš„ `max_tokens` é™åˆ¶
- å¯èƒ½éœ€è¦è”ç³»æ”¯æŒæˆ–æ›´æ¢æ¨¡å‹

### æ–¹æ¡ˆ 4ï¼šä½¿ç”¨ä¸åŒçš„æ¨¡å‹

```bash
# åœ¨ .env ä¸­å°è¯•å…¶ä»–æ¨¡å‹
VITE_CUSTOM_MODEL=deepseek-chat
# æˆ–
VITE_CUSTOM_MODEL=Qwen/Qwen2.5-72B-Instruct
```

---

## ğŸ“Š Token ä½¿ç”¨ä¼°ç®—

åŸºäºç»éªŒæ•°æ®ï¼š

| çŸ¥è¯†ç‚¹æ•°é‡ | è¾“å…¥ tokens | é¢„ä¼°è¾“å‡º tokens | æ€»è®¡ | æ¨èé…ç½® |
|-----------|-----------|---------------|------|---------|
| 1-3       | ~500-1000 | ~1500-3000    | ~2500 | maxTokens: 4096 |
| 4-7       | ~1500-2000 | ~4000-7000    | ~8000 | maxTokens: 8192 |
| 8-12      | ~2500-3500 | ~8000-12000   | ~15000 | maxTokens: 16384 |
| 13-15     | ~3500-4500 | ~12000-18000  | ~21000 | maxTokens: 32768 æˆ–åˆ†æ‰¹ |

**å½“å‰æƒ…å†µ**ï¼š14 ä¸ªçŸ¥è¯†ç‚¹
- é¢„ä¼°éœ€è¦ ~20000 tokens
- å½“å‰è®¾ç½® maxTokens: 16384
- **å¯èƒ½éœ€è¦ 32768 æˆ–åˆ†æ‰¹ç”Ÿæˆ**

---

## ğŸ”§ æ‰‹åŠ¨è°ƒæ•´ maxTokens

å¦‚æœ 16384 ä»ç„¶ä¸å¤Ÿï¼Œå¯ä»¥æ‰‹åŠ¨é…ç½®ï¼š

### æ–¹æ³• 1ï¼šä¿®æ”¹é»˜è®¤é…ç½®ï¼ˆå…¨å±€ï¼‰

```typescript
// src/lib/llm-client.ts
export const DEFAULT_CONFIG: Partial<LLMConfig> = {
  maxTokens: 32768, // 32K
  // ...
};
```

### æ–¹æ³• 2ï¼šè¿è¡Œæ—¶é…ç½®ï¼ˆé’ˆå¯¹å•æ¬¡è°ƒç”¨ï¼‰

```javascript
llm.configure({
  apiKey: 'sk-...',
  baseURL: 'https://api.siliconflow.cn/v1',
  model: 'deepseek-ai/DeepSeek-V3.1-Terminus',
  maxTokens: 32768, // â† è¦†ç›–é»˜è®¤å€¼
  timeout: 180000   // 3 åˆ†é’Ÿ
})

const data = await llm.generateFromPath({
  knowledge_path: knowledgePath
})
```

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **é‡å¯æœåŠ¡å™¨**ï¼š
   ```bash
   npm run dev
   ```

2. **æµ‹è¯• 14 ä¸ªçŸ¥è¯†ç‚¹**ï¼š
   ```javascript
   const data = await llm.generateFromPath({
     knowledge_path: knowledgePath,
     style: 'comprehensive'
   })
   ```

3. **æŸ¥çœ‹è°ƒè¯•è¾“å‡º**ï¼š
   - å¦‚æœ"åŸå§‹å“åº”é•¿åº¦" > 15000ï¼Œè¯´æ˜è¶³å¤Ÿäº†
   - å¦‚æœä»ç„¶ < 8000ï¼Œè¯´æ˜ API æœ‰ç¡¬é™åˆ¶
   - æŸ¥çœ‹"æˆªæ–­ç‚¹å‘¨å›´å†…å®¹"äº†è§£å…·ä½“æƒ…å†µ

4. **æ ¹æ®ç»“æœå†³å®š**ï¼š
   - âœ… æˆåŠŸ â†’ å¤ªå¥½äº†ï¼
   - âŒ ä»ç„¶æˆªæ–­ â†’ ä½¿ç”¨åˆ†æ‰¹ç”Ÿæˆæˆ–å‡å°‘çŸ¥è¯†ç‚¹

---

## ğŸ‰ æ€»ç»“

**å·²å®Œæˆçš„ä¼˜åŒ–**ï¼š
- âœ… maxTokens: 2000 â†’ 8192 â†’ **16384**
- âœ… timeout: 30s â†’ 60s â†’ **120s**
- âœ… æ·»åŠ è¯¦ç»†çš„æˆªæ–­ç‚¹è°ƒè¯•
- âœ… æ”¹è¿›çš„ JSON è§£æå’Œæ¢å¤
- âœ… æ™ºèƒ½æ‹¬å·é—­åˆ

**å½“å‰é…ç½®**ï¼š
- æœ€å¤§è¾“å‡ºï¼š**16384 tokens**
- è¶…æ—¶æ—¶é—´ï¼š**120 ç§’**
- æ”¯æŒçš„çŸ¥è¯†ç‚¹ï¼š**ç†è®ºä¸Š 8-12 ä¸ª**

**å¦‚æœ 14 ä¸ªçŸ¥è¯†ç‚¹ä»ç„¶å¤±è´¥**ï¼š
- å»ºè®®åˆ†æ‰¹ç”Ÿæˆï¼ˆ7+7ï¼‰
- æˆ–ä½¿ç”¨ `style: 'concise'`
- æˆ–è¿›ä¸€æ­¥å¢åŠ  maxTokens åˆ° 32768

---

**ç°åœ¨è¯·é‡å¯æœåŠ¡å™¨å¹¶æµ‹è¯•ï¼** ğŸš€

è°ƒè¯•è¾“å‡ºä¼šå‘Šè¯‰æˆ‘ä»¬ç¡®åˆ‡çš„é—®é¢˜æ‰€åœ¨ã€‚
